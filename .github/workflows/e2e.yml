name: E2E Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  e2e:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      redis:
        image: redis
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgresql:
        image: pgvector/pgvector:pg18
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: pass
          POSTGRES_DB: cat
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      ollama:
        image: ollama/ollama:latest
        ports:
          - 11434:11434
        options: >-
          --health-cmd "ollama list || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Check Nx Sync
        run: pnpm nx sync:check

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps

      - name: Pull Ollama Models
        run: |
          echo "Pulling qwen2.5:0.5b..."
          curl -X POST http://localhost:11434/api/pull -d '{"name": "qwen2.5:0.5b", "stream": false}'
          echo "Pulling nomic-embed-text..."
          curl -X POST http://localhost:11434/api/pull -d '{"name": "nomic-embed-text", "stream": false}'

      - name: Build & Load Plugins
        run: |
          pnpm build-plugins
          pnpm load-plugins

      - name: Run App
        run: pnpm exec nx preview app > app.log 2>&1 &
        env:
          PORT: 3000
          DATABASE_URL: postgresql://user:pass@localhost:5432/cat?schema=public
          REDIS_URL: redis://localhost:6379

      - name: Wait for Healthcheck
        timeout-minutes: 1
        run: |
          echo "Waiting for service to be healthy..."
          RETRIES=30
          until curl --output /dev/null --silent --head --fail http://localhost:3000/_health; do
            printf '.'
            sleep 2
            RETRIES=$((RETRIES-1))
            if [ $RETRIES -le 0 ]; then
              echo "Timeout waiting for service!"
              echo "================ APPLICATION LOGS ================"
              cat app.log
              echo "=================================================="
              exit 1
            fi
          done
          echo "Server is up!"

      - name: Run E2E Tests
        run: pnpm exec nx affected --target=test:e2e --parallel=1 || exit 0
        env:
          PORT: 3000
          DATABASE_URL: postgresql://user:pass@localhost:5432/cat?schema=public
          REDIS_URL: redis://localhost:6379

      - name: Upload Playwright Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: apps/app-e2e/playwright-report/
          retention-days: 30
