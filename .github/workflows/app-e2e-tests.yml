name: APP E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  app-e2e-tests:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24-dind
        options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm playwright install --with-deps
        working-directory: apps/app-e2e

      - name: Build plugins
        run: pnpm nx run-many --target=build --projects=@cat-plugin/*

      - name: Show project structure (ignore node_modules)
        run: |
          # 1. èƒ½å¦è¢« Node è§£æï¼ˆæœ€å…³é”®ï¼‰
          node -e "try{console.log('require.resolve ->', require.resolve('@cat/db'))}catch(e){console.error('require.resolve failed:', e.message)}"

          # 2. å¦‚æœä¸Šé¢æˆåŠŸï¼Œæ‰“å°å®é™…è¢«è§£æåˆ°çš„ package.json è·¯å¾„å’Œå†…å®¹
          node -e "try{const p=require.resolve('@cat/db/package.json'); console.log('pkg json resolved:', p); console.log(require('fs').readFileSync(p,'utf8'))}catch(e){console.error(e.message)}"

          # 3. åœ¨ä»“åº“é‡Œç¡®è®¤ packages/db çš„äº§ç‰©å’Œå¤§å°å†™
          ls -la packages/db
          ls -la packages/db/dist || true
          git ls-files | grep -i 'packages/db' || true

          pnpm -v
          pnpm -w ls --depth 0

          # 2) node_modules ä¸‹æ˜¯å¦æœ‰ @cat æ–‡ä»¶å¤¹ï¼ˆå¾ˆç›´æ¥ï¼‰
          ls -la node_modules/@cat || true

          # 3) pnpm çš„ .pnpm ä¸­æ˜¯å¦å­˜åœ¨ @cat/db è®°å½•ï¼ˆpnpmç‹¬æœ‰ç»“æ„ï¼‰
          ls -la node_modules/.pnpm | grep cat || true
          ls -la node_modules/.pnpm/*@cat* || true

          # 4) packages/db çš„ package.json ä¸­ name å­—æ®µç¡®è®¤
          cat packages/db/package.json

          # 5) æ˜¾ç¤º workspace é…ç½®ï¼ˆçœ‹çœ‹ root package.json æˆ– pnpm-workspace.yamlï¼‰
          cat package.json
          cat pnpm-workspace.yaml || true

      - name: Load plugins
        run: pnpm load-internal-plugins

      - name: Build app
        run: pnpm nx build app

      - name: Start Docker services
        run: |
          echo "ğŸ³ Start docker..."
          docker compose up -d --wait
        working-directory: apps/app-e2e

      - name: Start application
        run: |
          echo "ğŸš€ Prepare db enviroment for app preview..."
          pnpm start
          echo "â³ Wait ..."
          sleep 15

          # Verify preview start
          timeout 60s bash -c 'until curl -f http://localhost:3000/api/__health || curl -f http://localhost:3000/api/__health; do sleep 2; done' || {
            echo "âŒ app preview start failed"
            echo "Logs:"
            jobs
            exit 1
          }

          echo "âœ… app preview start successfully"
        working-directory: apps/app-e2e
        env:
          DATABASE_URL: "postgresql://user:pass@localhost:5432/cat?schema=public"

      - name: Run E2E tests
        run: |
          echo "ğŸ§ª Run E2E..."
          pnpm playwright test
        working-directory: apps/app-e2e
        env:
          CI: true

      - name: Cleanup Docker services
        if: always()
        run: |
          echo "ğŸ›‘ Cleaup..."
          docker compose down --rmi all -v || true
          docker system prune -af || true
        working-directory: apps/app-e2e
