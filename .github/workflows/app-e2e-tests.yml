name: APP E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  app-e2e-tests:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24-dind
        options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm playwright install --with-deps
        working-directory: apps/app-e2e

      - name: Build plugins
        run: pnpm nx run-many --target=build --projects=@cat-plugin/*

      - name: Show project structure (ignore node_modules)
        run: |
          # 1. 能否被 Node 解析（最关键）
          node -e "try{console.log('require.resolve ->', require.resolve('@cat/db'))}catch(e){console.error('require.resolve failed:', e.message)}"

          # 2. 如果上面成功，打印实际被解析到的 package.json 路径和内容
          node -e "try{const p=require.resolve('@cat/db/package.json'); console.log('pkg json resolved:', p); console.log(require('fs').readFileSync(p,'utf8'))}catch(e){console.error(e.message)}"

          # 3. 在仓库里确认 packages/db 的产物和大小写
          ls -la packages/db
          ls -la packages/db/dist || true
          git ls-files | grep -i 'packages/db' || true

          pnpm -v
          pnpm -w ls --depth 0

          # 2) node_modules 下是否有 @cat 文件夹（很直接）
          ls -la node_modules/@cat || true

          # 3) pnpm 的 .pnpm 中是否存在 @cat/db 记录（pnpm独有结构）
          ls -la node_modules/.pnpm | grep cat || true
          ls -la node_modules/.pnpm/*@cat* || true

          # 4) packages/db 的 package.json 中 name 字段确认
          cat packages/db/package.json

          # 5) 显示 workspace 配置（看看 root package.json 或 pnpm-workspace.yaml）
          cat package.json
          cat pnpm-workspace.yaml || true

      - name: Load plugins
        run: pnpm load-internal-plugins

      - name: Build app
        run: pnpm nx build app

      - name: Start Docker services
        run: |
          echo "🐳 Start docker..."
          docker compose up -d --wait
        working-directory: apps/app-e2e

      - name: Start application
        run: |
          echo "🚀 Prepare db enviroment for app preview..."
          pnpm start
          echo "⏳ Wait ..."
          sleep 15

          # Verify preview start
          timeout 60s bash -c 'until curl -f http://localhost:3000/api/__health || curl -f http://localhost:3000/api/__health; do sleep 2; done' || {
            echo "❌ app preview start failed"
            echo "Logs:"
            jobs
            exit 1
          }

          echo "✅ app preview start successfully"
        working-directory: apps/app-e2e
        env:
          DATABASE_URL: "postgresql://user:pass@localhost:5432/cat?schema=public"

      - name: Run E2E tests
        run: |
          echo "🧪 Run E2E..."
          pnpm playwright test
        working-directory: apps/app-e2e
        env:
          CI: true

      - name: Cleanup Docker services
        if: always()
        run: |
          echo "🛑 Cleaup..."
          docker compose down --rmi all -v || true
          docker system prune -af || true
        working-directory: apps/app-e2e
